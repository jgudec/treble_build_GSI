From 8bd4ba190736c36e429a6e4a0ea2045ac06e1fc0 Mon Sep 17 00:00:00 2001
From: jgudec <jakov.gudec@gmail.com>
Date: Wed, 31 Aug 2022 21:58:32 +0200
Subject: [PATCH 8/9] Add min and max refresh rate options

---
 app/src/main/java/me/phh/treble/app/Misc.kt   | 12 +++++++++++
 .../java/me/phh/treble/app/MiscSettings.kt    |  2 ++
 app/src/main/res/values/arrays.xml            | 21 +++++++++++++++++++
 app/src/main/res/xml/pref_misc.xml            | 12 +++++++++++
 4 files changed, 47 insertions(+)
 create mode 100644 app/src/main/res/values/arrays.xml

diff --git a/app/src/main/java/me/phh/treble/app/Misc.kt b/app/src/main/java/me/phh/treble/app/Misc.kt
index 0cdb728..7ed780d 100644
--- a/app/src/main/java/me/phh/treble/app/Misc.kt
+++ b/app/src/main/java/me/phh/treble/app/Misc.kt
@@ -257,6 +257,16 @@ object Misc: EntryStartup {
                 val value = sp.getString(key, "00ff00")
                 SystemProperties.set("persist.sys.phh.fod_color", value)
             }
+            MiscSettings.minHz -> {
+                val value = sp.getString(key, "-1").toInt()
+                    Settings.System.putInt(c.contentResolver,
+                        "MIN_REFRESH_RATE".toLowerCase(), value);
+            }
+            MiscSettings.maxHz -> {
+                val value = sp.getString(key, "-1").toInt()
+                    Settings.System.putInt(c.contentResolver,
+                        "PEAK_REFRESH_RATE".toLowerCase(), value);
+            }
         }
     }
 
@@ -283,5 +293,7 @@ object Misc: EntryStartup {
         spListener.onSharedPreferenceChanged(sp, MiscSettings.noHwcomposer)
         spListener.onSharedPreferenceChanged(sp, MiscSettings.storageFUSE)
         spListener.onSharedPreferenceChanged(sp, MiscSettings.dt2w)
+        spListener.onSharedPreferenceChanged(sp, MiscSettings.minHz)
+        spListener.onSharedPreferenceChanged(sp, MiscSettings.maxHz)
     }
 }
diff --git a/app/src/main/java/me/phh/treble/app/MiscSettings.kt b/app/src/main/java/me/phh/treble/app/MiscSettings.kt
index 99593c9..9d75f78 100644
--- a/app/src/main/java/me/phh/treble/app/MiscSettings.kt
+++ b/app/src/main/java/me/phh/treble/app/MiscSettings.kt
@@ -38,6 +38,8 @@ object MiscSettings : Settings {
     val dt2w = "key_misc_dt2w"
     val restartSystemUI = "key_misc_restart_systemui"
     val fodColor = "key_misc_fod_color"
+    val minHz = "key_misc_min_hz"
+    val maxHz = "key_misc_max_hz"
 
     override fun enabled() = true
 }
diff --git a/app/src/main/res/values/arrays.xml b/app/src/main/res/values/arrays.xml
new file mode 100644
index 0000000..dd24c1d
--- /dev/null
+++ b/app/src/main/res/values/arrays.xml
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="utf-8"?>
+
+<!-- All lists for ListPreference keys/values are placed here -->
+<resources>
+    <array name="pref_misc_display_refresh_rate">
+        <item>"10 Hz"</item>
+        <item>"24 Hz"</item>
+        <item>"48 Hz"</item>
+        <item>"60 Hz"</item>
+        <item>"96 Hz"</item>
+        <item>"120 Hz"</item>
+    </array>
+    <array name="pref_misc_refresh_rate_values">
+        <item>"10"</item>
+        <item>"24"</item>
+        <item>"48"</item>
+        <item>"60"</item>
+        <item>"96"</item>
+        <item>"120"</item>
+    </array>
+</resources>
\ No newline at end of file
diff --git a/app/src/main/res/xml/pref_misc.xml b/app/src/main/res/xml/pref_misc.xml
index b90d0f0..fd6674a 100644
--- a/app/src/main/res/xml/pref_misc.xml
+++ b/app/src/main/res/xml/pref_misc.xml
@@ -53,6 +53,18 @@
 			android:entryValues="@array/pref_misc_display_fps_values"
 			android:key="key_misc_display_fps"
 			android:title="Force FPS" />
+		<ListPreference
+			android:defaultValue="10"
+			android:entries="@array/pref_misc_display_refresh_rate"
+			android:entryValues="@array/pref_misc_refresh_rate_values"
+			android:key="key_misc_min_hz"
+			android:title="Minimum refresh rate" />
+		<ListPreference
+			android:defaultValue="120"
+			android:entries="@array/pref_misc_display_refresh_rate"
+			android:entryValues="@array/pref_misc_refresh_rate_values"
+			android:key="key_misc_max_hz"
+			android:title="Maximum refresh rate" />
         <Preference
             android:key="key_misc_restart_systemui"
             android:title="Restart SystemUI"
-- 
2.17.1

